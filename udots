#!/usr/bin/env bash

CONFIG="$HOME/.config/udots/"
REPO="$HOME/git/termux-cfg"
VERSION="0.4.0"

checkDir () {
  if [[ ! -d "$1" ]]; then
    mkdir -p "$1"
  fi
}

checkDir "$CONFIG"
checkDir "$REPO"

fullPath () {
  # Remove ending /
  currentTarget="${1/%\//}"

  # If target is a path
  if [[ "$currentTarget" =~ "/" ]]; then
    # Split last item and path
    IFS=" " read -d "" -r dirName lastItem <<< "${currentTarget%\/*} ${currentTarget##*\/}"

    echo "$(cd "$dirName"; pwd)/$lastItem"
  else
    # Append current dir to the item
    echo "$PWD/$currentTarget"
  fi
}

case "$1" in
  "--add"|"-a")
    pkgName="$2"
    targets=("${@:3}")

    for target in "${targets[@]}"; do
      targetPath="$(fullPath "$target")" 
      targetItem="${targetPath##*\/}"

      tmpPath="${targetPath/$HOME\//}"
      newPath="${tmpPath/%\/$targetItem/}"

      mkdir -p "$REPO/$pkgName/$newPath"
      mv "$targetPath" "$REPO/$pkgName/$newPath"
      stow -d "$REPO" -t "$HOME" "$pkgName"

      # =========================================
      # DEBUGGING ONLY
      # =========================================
      #echo "# ========================================="
      #echo "Config Directory: $CONFIG"
      #echo "Repo Directory: $REPO"
      #echo "Package Name: $pkgName"
      #echo "Target Path: $targetPath"
      #echo "Target Item: $targetItem"
      #echo "New Path: $newPath"
      #echo "Moved to: $REPO/$pkgName/$newPath"
      #echo -e "# =========================================\n"
      # =========================================
    done
    ;;

  "--version"|"-v")
    echo "udots Version ${VERSION}"
    ;;

  *)
    stow -d "$REPO" -t "$HOME" "$1"
    ;;
esac
